<!DOCTYPE html>
<html>
<head>
  <title>Editor de reporte diario</title>
  <!-- <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet"> -->
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <style>
    #editor { 
      width: 794px; 
      height: 500px; 
      margin: 0 auto;
      padding: 40px;
      background: white;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      box-sizing: border-box;
      flex: 1;
      overflow-y: auto;     /* Scrollable content */

    }
    #editor img {
      max-width: 714px;
    }
    .button {
      margin-top: 10px; 
    }
    #html-view { 
      display:none;
      width: 794px; 
      /* width:100%;  */
      height:500px; 
    }
    .ql-toolbar button {
      background: none;
      border: none;
      cursor: pointer;
      display: inline-block;
      float: left;
      height: 24px;
      padding: 3px 5px;
      width: 28px;
    }
    .ql-toolbar button svg {
      float: left;
      height: 100%;
    }
    .ql-toolbar button:active:hover {
      outline: none;
    }
  </style>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Instituto Nacional del Agua (INA) - Subgerencia Laboratorio de Hidrología</title>
  <meta name="description"
    content="Es un organismo científico tecnológico descentralizado que tiene por objetivo satisfacer los requerimientos de estudio,    investigación, desarrollo y prestación de servicios especializados en el campo del aprovechamiento y preservación del agua.    Depende de la Secretaría de Infraestructura y Política Hídrica de la Nación,    del [Ministerio de Obras Públicas](https://www.argentina.gob.ar/obras-publicas) de la República Argentina.">
  <meta name="keywords"
    content="instituto nacional del agua, INA, ina, subsecretaria de recursos hidricos, laboratorio de hidraulica,    direccion de servicios hidrologicos, centro de tecnologia del uso del agua, centro regional litoral, crl, centro de la region semiarida, cirsa,    centro de economia legislacion y administracion del agua, cela, subgerencia laboratorio de calidad de aguas, subgerencia hidrologia aplicada, delta parana, inundaciones urbanas, productos de emergencia, analisis de agua, alerta hidrologico, monitoreo rio parana,   cuenca del plata, investigaciones en riego y drenaje, calidad de aguas, canal de panama, hidraulica, ingenieria hidraulica, hidrologia superficial,    hidrologia subterranea, programa de investigaciones en hidroquimica, red hidrometeorologica, area pedemontana gran mendoza,   calidad de aguas e impacto ambiental">
  <meta name="author" content="Instituto Nacional del Agua">
  <link rel="shortcut icon" href="https://www.ina.gov.ar/img/favicon.ico">
  <!-- Nav and address bar color -->
  <meta name="theme-color" content="#0072b8">
  <meta name="msapplication-navbutton-color" content="#0072b8">
  <meta name="apple-mobile-web-app-status-bar-style" content="#0072b8">
  <meta property="og:url" content="https://www.argentina.gob.ar/ina/">
  <meta property="og:type" content="article">
  <meta property="og:title" content="Instituto Nacional del Agua (INA) - Subgerencia Laboratorio de Hidrología">
  <meta property="og:description"
    content="Es un organismo científico tecnológico descentralizado que tiene por objetivo satisfacer los requerimientos de estudio,    investigación, desarrollo y prestación de servicios especializados en el campo del aprovechamiento y preservación del agua.    Depende de la Secretaría de Infraestructura y Política Hídrica de la Nación,    del [Ministerio de Obras Públicas](https://www.argentina.gob.ar/obras-publicas) de la República Argentina.">
  <meta property="og:image" content="https://www.ina.gob.ar/img/Logo_ina_chico.png">
  <meta property="og:locale" content="es_AR">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Instituto Nacional del Agua (INA) - Subgerencia Laboratorio de Hidrología">
  <meta name="twitter:description"
    content="Es un organismo científico tecnológico descentralizado que tiene por objetivo satisfacer los requerimientos de estudio,    investigación, desarrollo y prestación de servicios especializados en el campo del aprovechamiento y preservación del agua.    Depende de la Secretaría de Infraestructura y Política Hídrica de la Nación,    del [Ministerio de Obras Públicas](https://www.argentina.gob.ar/obras-publicas) de la República Argentina.">
  <meta name="twitter:image" content="https://www.ina.gob.ar/img/Logo_ina_chico.png">
  <link rel="stylesheet" href="styles/bootstrap.min.css"
    integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">
  <link rel="stylesheet" href="styles/font-awesome.min.css">
  <link rel="stylesheet" href="styles/poncho.min.css">
  <!-- <link rel="stylesheet" href="/poncho/dist/css/argentina.css"> -->
  <link rel="stylesheet" href="styles/icono-arg.css">
  <link rel="stylesheet" href="styles/ina.css">
  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
          <script src="http://argob.github.io/poncho/js/html5shiv.js"></script>
          <script src="http://argob.github.io/poncho/js/respond.min.js"></script>
      <![endif]-->
  <script src="js/jquery.min.js"></script>
  <script src="js/bootstrap.min.js"
    integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd"
    crossorigin="anonymous"></script>
  <link href="styles/owl.carousel.css" type="text/css" rel="stylesheet" media="screen">
  <script src="js/owl.carousel.min.js" type="text/javascript"></script>
  <script src="https://unpkg.com/prettier@3.2.5/standalone.js"></script>
  <script src="https://unpkg.com/prettier@3.2.5/parser-html.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/quill-better-table@1.2.8/dist/quill-better-table.css">
</head>
<body>
  <div>
    <h1>Editar reporte diario</h1>
    <div style="display: grid; place-items: center;">
      <button id="toggleView">Cambiar a vista de código</button>
      <div id="toolbar">
        <button class="ql-bold"><i class="fas fa-bold"></i></button>
        <button class="ql-italic"><i class="fas fa-italic"></i></button>
        <select class="ql-header">
          <option value="1">H1</option>
          <option value="2">H2</option>
          <option selected>Normal</option>
        </select>
        <button class="ql-list" value="ordered"><i class="fas fa-list-ol"></i></button>
        <button class="ql-list" value="bullet"><i class="fas fa-list-ul"></i></button>
        <button class="ql-image"><i class="fas fa-image"></i></button>
        <!-- <button class="ql-insertTable"><i class="fa-solid fa-table"></i></button> -->
      </div>
      <div id="editor"></div>
      <textarea id="html-view"></textarea>
      <div>
        <button class="button" id=save-button onclick="saveContent()">Guardar</button>
        <span>
          <button class="button" id=load-template-button onclick="startFromTemplate()">Cargar plantilla</button>
        </span>
        <span>
          <a href="reporte_diario.html" target="_blank">Ver</a>
        </span>
      </div>
    </div>
  </div>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/quill/2.0.0-dev.3/quill.min.js" type="text/javascript"></script> -->
  <script src="https://unpkg.com/quill-better-table@1.2.10/dist/quill-better-table.min.js"></script>
  <script>
    // Quill.register({
    //   'modules/better-table': quillBetterTable
    // }, true)
    // window.onload = () => {

      const quill = new Quill('#editor', { 
        modules: {
          toolbar: '#toolbar',
          clipboard: true,
          // table: false,  // disable table module
          // 'better-table': {
          //   operationMenu: {
          //     items: {
          //       unmergeCells: {
          //         text: 'Another unmerge cells name'
          //       }
          //     }
          //   }
          // },
          // keyboard: {
          //   bindings: quillBetterTable.keyboardBindings
          // }
        },
        theme: null 
      });
      // const Delta = Quill.import('delta');
      // const clipboard = quill.getModule('clipboard');

      // clipboard.addMatcher('DIV', (node, delta) => {
      //   const classAttr = node.getAttribute('class');
      //   if (classAttr) {
      //     // Apply as a custom attribute in Delta
      //     return delta.compose(new Delta().retain(delta.length(), {
      //       class: classAttr
      //     }));
      //   }
      //   return delta;
      // });

      // Load existing content
      fetch('/content')
        .then(res => res.text())
        .then(html => {
          // const parser = new Clipboard(quill, quill.options.modules.clipboard)
          html = convertTablesToP(html)
          const delta = quill.getModule('clipboard').convert(html);
          quill.setContents(delta);
          console.debug(delta)
        });

      const toggleBtn = document.getElementById('toggleView');
      const htmlView = document.getElementById('html-view');
      const editorContainer = document.getElementById('editor');

      let codeView = false;

      toggleBtn.addEventListener('click', async () => {
        codeView = !codeView;

        if (codeView) {
          // Switch to HTML view
          const rawHtml = quill.root.innerHTML;
          const formatted = await prettier.format(rawHtml, {
            parser: 'html',
            plugins: prettierPlugins
          });
          htmlView.value = formatted;
          htmlView.style.display = 'block';
          editorContainer.style.display = 'none';
          toggleBtn.textContent = 'Cambiar a WYSIWYG';
          document.getElementById("save-button").disabled = true
          document.getElementById("load-template-button").disabled = true
          document.getElementById("toolbar").style.display = "none" 
        } else {
          // Switch back to Quill
          // quill.root.innerHTML = htmlView.value;
          // const parser = new Clipboard(quill, quill.options.modules.clipboard)
          var html = htmlView.value
          html = convertTablesToP(html)
          const delta = quill.getModule('clipboard').convert(html);
          // const delta = quill.clipboard.convert(htmlView.value);
          quill.setContents(delta);
          htmlView.style.display = 'none';
          editorContainer.style.display = 'block';
          toggleBtn.textContent = 'Cambiar a vista de código';
          document.getElementById("save-button").disabled = false
          document.getElementById("load-template-button").disabled = false
          document.getElementById("toolbar").style.display = "block" 
        }
      });

      // document.querySelector('.ql-insertTable').addEventListener('click', () => {
      //   const tableModule = quill.getModule('better-table');
      //   tableModule.insertTable(3, 3); // rows, columns
      // });
    // }
      // Save content
    function saveContent() {
      const html = quill.root.innerHTML;
      fetch('/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ html })
      }).then(res => res.text()).then(alert);
    }

    // new from template
    function startFromTemplate() {
      fetch('/template')
      .then(res => res.text())
      .then(html => {
        html = convertTablesToP(html)
        const delta = quill.getModule('clipboard').convert(html);
        quill.setContents(delta);
        // document.querySelector("div.ql-editor").innerHTML = html
      });
    }

    function htmlStringToDOM(html) {
      return new DOMParser().parseFromString(html, 'text/html').body;
    }

    function tableToCSV(table, sep=',',linebreak='<br>') {
      const rows = Array.from(table.querySelectorAll('tr'));
      return rows.map(row => {
        const cells = Array.from(row.querySelectorAll('th, td'));
        return cells.map(cell => `${cell.textContent.replace(/"/g, '""')}`).join(sep);
      }).join(linebreak);
    }

    function replaceElements(dom, selector, replacer) {
      const elements = dom.querySelectorAll(selector);
      elements.forEach(el => {
        const replacement = replacer(el);
        if (replacement instanceof Node) {
          el.replaceWith(replacement);
        }
      });
    }

    function convertTablesToP(html) {
      const dom = htmlStringToDOM(html)
      // const tables = dom.getElementsByTagName("table")
      replaceElements(dom, "table", table => {
        const div = document.createElement('div');
        div.classList.add("csv-table")
        div.innerHTML = tableToCSV(table,";")
        return div
      })
      return dom.innerHTML
    }



  </script>
</body>
</html>
